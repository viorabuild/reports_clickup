# ClickUp Reports Agent

Простой CLI-агент, который просматривает задачи в списке ClickUp, просит локальную модель LM Studio (Qwen3-VL 4B) выставить оценки за скорость и качество, сохраняет их в кастомных полях, добавляет комментарий с обоснованием и при необходимости переводит задачу в статус «Закрыта».

## Требования

- Python 3.10+
- Доступ к ClickUp API токену с правами чтения/записи задач
- Запущенный LM Studio HTTP сервер (по умолчанию `http://127.0.0.1:1234`) с моделью `qwen/qwen3-vl-4b`

## Установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## Переменные окружения

| Переменная | Назначение |
| --- | --- |
| `CLICKUP_API_TOKEN` | Личный токен ClickUp. |
| `CLICKUP_LIST_ID` | ID списка, из которого тянем задачи (укажите либо его, либо `CLICKUP_SPACE_ID`). |
| `CLICKUP_SPACE_ID` | ID пространства ClickUp, которое нужно обработать целиком. |
| `CLICKUP_SPEED_FIELD_ID` | ID кастомного поля «Скорость». |
| `CLICKUP_QUALITY_FIELD_ID` | ID кастомного поля «Качество». |
| `CLICKUP_TARGET_STATUSES` | (опционально) Статусы через запятую, которые нужно обрабатывать. |
| `CLICKUP_AUTO_CLOSE_STATUSES` | (опционально) Статусы, после оценки переводить в `CLICKUP_CLOSED_STATUS`. |
| `CLICKUP_CLOSED_STATUS` | (опционально) Название статуса для закрытия задачи (работает только вместе с `CLICKUP_AUTO_CLOSE_STATUSES`). |
| `CLICKUP_MAX_TASKS` | (опционально) Лимит задач за один запуск (по умолчанию обрабатываются все; можно переопределить флагом `--max-tasks`). |
| `LM_STUDIO_BASE_URL` | URL локального LM Studio (по умолчанию `http://127.0.0.1:1234`). |
| `LM_STUDIO_MODEL` | Имя модели (по умолчанию `qwen/qwen3-vl-4b`). |
| `LM_TEMPERATURE` | Temperature для генерации (по умолчанию `0.2`). |
| `ASSESSMENT_HISTORY_LIMIT` | (опционально) Максимум последних записей об оценках, которые хранит агент (по умолчанию 5). |
| `ASSESSMENT_HISTORY_PATH` | (опционально) Путь к файлу, где сохраняется история оценок (по умолчанию `reports/assessments.md`). |

Для удобства создайте файл `.env` рядом со скриптом и заполните его нужными значениями.

Пример `.env`:

```env
CLICKUP_API_TOKEN=pk_ваш_clickup_token
# Укажите один источник задач — список или пространство
# CLICKUP_LIST_ID=123456789
CLICKUP_SPACE_ID=987654321
CLICKUP_SPEED_FIELD_ID=custom_скорость
CLICKUP_QUALITY_FIELD_ID=custom_качество
```

> Важно: задайте **только один** источник задач — `CLICKUP_LIST_ID` **или** `CLICKUP_SPACE_ID`. Если указать оба либо ни одного, агент не запустится.

## Запуск

```bash
python -m src.clickup_agent
```

Флаг `--dry-run` позволяет посмотреть, что бы сделал агент, без реальных изменений в ClickUp:

```bash
python -m src.clickup_agent --dry-run
```

Чтобы обработать ограниченное число задач без изменения переменных окружения, используйте флаг `--max-tasks`:

```bash
python -m src.clickup_agent --max-tasks 3
```

## Как это работает

1. Агент загружает задачи из указанного списка или пространства ClickUp (можно ограничить конкретными статусами).
2. Для каждой задачи формируется промпт и отправляется запрос в LM Studio.
3. Модель возвращает JSON с полями `speed_score`, `quality_score` и кратким комментарием (≤ 50 слов).
4. Значения записываются в кастомные поля, добавляется комментарий к задаче.
5. Если текущий статус задачи входит в `CLICKUP_AUTO_CLOSE_STATUSES`, она переводится в `CLICKUP_CLOSED_STATUS`.

## Советы

- Чтобы ускорить отладку, задайте `CLICKUP_MAX_TASKS=3`.
- Альтернативно укажите `--max-tasks`, чтобы не менять конфигурацию окружения.
- Если включаете автоматическое закрытие, задайте оба значения: `CLICKUP_AUTO_CLOSE_STATUSES` и `CLICKUP_CLOSED_STATUS`.
- При смене выбранных задач используйте `CLICKUP_TARGET_STATUSES`, напр. `CLICKUP_TARGET_STATUSES=готово,complete`.
- Логи выводятся в STDOUT; настройте уровень логирования через переменную `PYTHONLOGGING` или редактируйте конфигурацию в `main()`.

ClickUp GPT Recommendation Agent
Автоматизированный агент, который анализирует задачи в ClickUp с помощью GPT и пишет структурированные рекомендации прямо в карточку задачи.
Возможности
Подключение к ClickUp API (чтение задач и обновление кастомного поля).
Формирование промпта на основе ключевых полей задачи.
Вызов OpenAI Chat Completions API и парсинг структурированного ответа.
Запись результата в кастомное поле «GPT Рекомендация».
Обработка задач батчами с бэкофом при rate limit.
Генерация ежедневных отчётов по всем сотрудникам с детальной статистикой:
Количество выполненных задач с указанием срочности
Плановое и фактическое время выполнения
Статистика по приоритетам (высокая/средняя/низкая)
Перенесённые и просроченные задачи
Архитектура
┌─────────────┐      ┌──────────────┐      ┌─────────────┐
│   ClickUp   │ ←──→ │  ИИ-агент    │ ←──→ │  GPT API    │
│   (задачи)  │      │  (обработка) │      │ (анализ)    │
└─────────────┘      └──────────────┘      └─────────────┘
Компоненты реализованы в пакете clickup_agent:
config.py — загрузка настроек из окружения.
clickup.py — HTTP-клиент ClickUp.
gpt.py — модуль анализа задач через GPT.
orchestrator.py — управление потоком обработки.
reports.py — генерация ежедневных отчётов по сотрудникам.
__main__.py — CLI-входная точка (python -m clickup_agent).
Подготовка окружения
Создайте виртуальное окружение и установите зависимости:
   python -m venv .venv
   source .venv/bin/activate
   pip install -e .
   
Скопируйте .env.example → .env и заполните значения:
CLICKUP_API_TOKEN
CLICKUP_LIST_ID или CLICKUP_TEAM_ID
CLICKUP_CUSTOM_FIELD_ID
OPENAI_API_KEY
Запуск
Анализ задач с GPT
python -m clickup_agent analyze --dry-run --status "in progress"
Ключи:
--status — фильтр по статусу (можно указать несколько раз).
--assignee — фильтр по исполнителю.
--dry-run — не записывать результат обратно в ClickUp.
Генерация ежедневных отчётов
python -m clickup_agent report --date 2025-10-29 --output reports.txt
Ключи:
--date — дата отчёта в формате YYYY-MM-DD (по умолчанию: сегодня).
--output — путь к файлу для сохранения отчётов (по умолчанию: вывод в консоль).
Глобальные ключи:
--log-level — уровень логирования (DEBUG, INFO, ...).
Cron / Scheduler
Пример cron-заданий:
Анализ задач каждые 30 минут:
*/30 * * * * cd /path/to/clickup-system && /path/to/.venv/bin/python -m clickup_agent analyze --status "in progress"
Ежедневные отчёты в 18:00:
0 18 * * * cd /path/to/clickup-system && /path/to/.venv/bin/python -m clickup_agent report --output /path/to/reports/daily_$(date +\%Y\%m\%d).txt
Или задеплойте контейнер в AWS Lambda / Cloud Run с планировщиком.
Roadmap
MVP: уже реализовано — базовая интеграция, один кастомный field, запуск по расписанию.
v2.0: webhook для near real-time, конфигурируемые промпты, метрики.
v3.0: персонализация, мульти-платформенность.
Тестирование
Модульные тесты не входят в MVP, но рекомендуемый минимум:
тест форматирования Markdown (GPTRecommendation.to_markdown).
мок ClickUp+GPT для «сухого» прогона пайплайна.
Безопасность
Храните ключи только в .env или secret manager.
Не логируйте чувствительные данные.
Используйте --dry-run при первоначальном запуске на продовых задачах.
Логирование и наблюдаемость
Логирование настраивается стандартным logging. Интегрируйте с Sentry / CloudWatch по необходимости. Для метрик можно собирать:
количество задач за запуск;
процент успешных обновлений;
latency GPT/ClickUp вызовов;
стоимость токенов (через billing API).

